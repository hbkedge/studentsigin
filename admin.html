<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>選手簽到系統 - 後台管理</title>
    <link rel="stylesheet" href="./styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .admin-header h1 {
            margin: 0;
            font-size: 2rem;
        }
        
        .admin-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn-filter {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-filter:hover {
            background: #5a6fd8;
        }
        
        .btn-export {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-export:hover {
            background: #229954;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .records-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            margin: 0;
            color: #333;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .attendance-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .attendance-type.checkin {
            background: #d4edda;
            color: #155724;
        }
        
        .attendance-type.checkout {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .current-page {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .supabase-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .supabase-status.connected {
            border-left-color: #27ae60;
            background: #d4edda;
        }
        
        .supabase-status.error {
            border-left-color: #e74c3c;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <a href="index.html" class="back-link">
            <i class="fas fa-arrow-left"></i> 返回簽到頁面
        </a>
        
        <div class="admin-header">
            <h1><i class="fas fa-tachometer-alt"></i> 選手簽到系統 - 後台管理</h1>
            <p>查看和管理所有簽到記錄 (Supabase雲端資料庫)</p>
        </div>
        
        <!-- Supabase連接狀態 -->
        <div id="supabaseStatus" class="supabase-status">
            <i class="fas fa-spinner fa-spin"></i> 正在檢查Supabase連接...
        </div>
        
        <!-- 統計卡片 -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="icon" style="color: #667eea;">
                    <i class="fas fa-users"></i>
                </div>
                <div class="number" id="totalRecords">-</div>
                <div class="label">總記錄數</div>
            </div>
            <div class="stat-card">
                <div class="icon" style="color: #27ae60;">
                    <i class="fas fa-sign-in-alt"></i>
                </div>
                <div class="number" id="totalCheckins">-</div>
                <div class="label">總簽到數</div>
            </div>
            <div class="stat-card">
                <div class="icon" style="color: #e74c3c;">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <div class="number" id="totalCheckouts">-</div>
                <div class="label">總簽退數</div>
            </div>
            <div class="stat-card">
                <div class="icon" style="color: #f39c12;">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="number" id="todayRecords">-</div>
                <div class="label">今日記錄</div>
            </div>
        </div>
        
        <!-- 篩選器 -->
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filterDate">日期</label>
                    <input type="date" id="filterDate" name="date">
                </div>
                <div class="filter-group">
                    <label for="filterType">簽到類型</label>
                    <select id="filterType" name="type">
                        <option value="">全部</option>
                        <option value="checkin">上學簽到</option>
                        <option value="checkout">放學簽退</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterName">姓名</label>
                    <input type="text" id="filterName" name="employee_name" placeholder="輸入姓名搜尋">
                </div>
                <div class="filter-group">
                    <button class="btn-filter" onclick="applyFilters()">
                        <i class="fas fa-search"></i> 搜尋
                    </button>
                </div>
                <div class="filter-group">
                    <button class="btn-export" onclick="exportData()">
                        <i class="fas fa-download"></i> 匯出
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 記錄表格 -->
        <div class="records-table">
            <div class="table-header">
                <h3><i class="fas fa-list"></i> 簽到記錄</h3>
                <div id="recordCount">載入中...</div>
            </div>
            <div class="table-container">
                <div id="loadingMessage" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 載入中...
                </div>
                <div id="errorMessage" class="error" style="display: none;"></div>
                <table id="recordsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>姓名</th>
                            <th>班級</th>
                            <th>日期</th>
                            <th>時間</th>
                            <th>類型</th>
                            <th>地點</th>
                            <th>IP地址</th>
                            <th>提交時間</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination" style="display: none;">
                <button id="prevPage" onclick="changePage(-1)">
                    <i class="fas fa-chevron-left"></i> 上一頁
                </button>
                <span id="pageInfo">第 1 頁，共 1 頁</span>
                <button id="nextPage" onclick="changePage(1)">
                    下一頁 <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    
    <script src="./supabase-config.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await checkSupabaseConnection();
            await loadRecords();
            await updateStats();
        });
        
        // 檢查Supabase連接
        async function checkSupabaseConnection() {
            const statusElement = document.getElementById('supabaseStatus');
            
            try {
                if (!window.attendanceManager) {
                    throw new Error('Supabase管理器未初始化');
                }
                
                await window.attendanceManager.initialize();
                const result = await window.attendanceManager.testConnection();
                
                if (result.success) {
                    statusElement.className = 'supabase-status connected';
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Supabase連接正常';
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                statusElement.className = 'supabase-status error';
                statusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Supabase連接失敗: ${error.message}`;
                console.error('Supabase連接檢查失敗:', error);
            }
        }
        
        // 載入記錄
        async function loadRecords(page = 1) {
            try {
                showLoading(true);
                
                const limit = 20;
                const offset = (page - 1) * limit;
                
                const result = await window.attendanceManager.getAttendanceRecords(currentFilters, limit, offset);
                
                if (result.success) {
                    displayRecords(result.data);
                    updatePagination(result.total, page);
                    updateRecordCount(result.total);
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('載入記錄失敗: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // 顯示記錄
        function displayRecords(records) {
            const tbody = document.getElementById('recordsTableBody');
            const table = document.getElementById('recordsTable');
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #666;">沒有找到記錄</td></tr>';
            } else {
                tbody.innerHTML = records.map(record => `
                    <tr>
                        <td>${record.id}</td>
                        <td>${record.employee_name}</td>
                        <td>${record.department_text}</td>
                        <td>${record.attendance_date}</td>
                        <td>${record.attendance_time}</td>
                        <td><span class="attendance-type ${record.attendance_type}">${record.attendance_type_text}</span></td>
                        <td>${record.location_text}${record.custom_location ? ` (${record.custom_location})` : ''}</td>
                        <td>${record.ip_address}</td>
                        <td>${new Date(record.submitted_at).toLocaleString('zh-TW')}</td>
                    </tr>
                `).join('');
            }
            
            table.style.display = 'table';
        }
        
        // 更新統計
        async function updateStats() {
            try {
                const result = await window.attendanceManager.getStatistics();
                
                if (result.success) {
                    const stats = result.data;
                    
                    document.getElementById('totalRecords').textContent = stats.total;
                    document.getElementById('totalCheckins').textContent = stats.checkins;
                    document.getElementById('totalCheckouts').textContent = stats.checkouts;
                    document.getElementById('todayRecords').textContent = stats.today;
                }
            } catch (error) {
                console.error('更新統計失敗:', error);
            }
        }
        
        // 應用篩選器
        function applyFilters() {
            currentFilters = {
                date: document.getElementById('filterDate').value,
                type: document.getElementById('filterType').value,
                employee_name: document.getElementById('filterName').value
            };
            
            // 移除空值
            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) {
                    delete currentFilters[key];
                }
            });
            
            currentPage = 1;
            loadRecords(currentPage);
        }
        
        // 更新分頁
        function updatePagination(total, page) {
            const limit = 20;
            totalPages = Math.ceil(total / limit);
            currentPage = page;
            
            const pagination = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
            } else {
                pagination.style.display = 'flex';
                prevBtn.disabled = page <= 1;
                nextBtn.disabled = page >= totalPages;
                pageInfo.textContent = `第 ${page} 頁，共 ${totalPages} 頁`;
            }
        }
        
        // 換頁
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                loadRecords(newPage);
            }
        }
        
        // 更新記錄計數
        function updateRecordCount(total) {
            document.getElementById('recordCount').textContent = `共 ${total} 筆記錄`;
        }
        
        // 顯示載入狀態
        function showLoading(show) {
            const loading = document.getElementById('loadingMessage');
            const table = document.getElementById('recordsTable');
            const pagination = document.getElementById('pagination');
            
            if (show) {
                loading.style.display = 'block';
                table.style.display = 'none';
                pagination.style.display = 'none';
            } else {
                loading.style.display = 'none';
            }
        }
        
        // 顯示錯誤
        function showError(message) {
            const error = document.getElementById('errorMessage');
            error.textContent = message;
            error.style.display = 'block';
        }
        
        // 匯出數據
        function exportData() {
            // 創建CSV內容
            const table = document.getElementById('recordsTable');
            const rows = table.querySelectorAll('tr');
            let csvContent = '';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowData = Array.from(cells).map(cell => {
                    let text = cell.textContent.trim();
                    // 處理包含逗號的內容
                    if (text.includes(',') || text.includes('"')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    return text;
                });
                csvContent += rowData.join(',') + '\n';
            });
            
            // 下載CSV文件
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `簽到記錄_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
